# Redirect HTTP -> HTTPS
server {
    listen 80;
    server_name cbmmalacca.freemem.space;

    # Certbot challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS
server {
    listen 443 ssl http2;
    server_name cbmmalacca.freemem.space;

    ssl_certificate /etc/letsencrypt/live/cbmmalacca.freemem.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cbmmalacca.freemem.space/privkey.pem;

    # SSL config recomendada
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # Headers de seguridad
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    client_max_body_size 64M;

    # Frontend React (build estatico)
    root /var/www/frontend;
    index index.html;

    # SPA: todas las rutas van a index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # WordPress API
    location /wp-json/ {
        root /var/www/html;
        try_files $uri $uri/ /index.php?$args;

        location ~ \.php$ {
            fastcgi_pass wordpress:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    # WordPress Admin
    location /wp-admin/ {
        root /var/www/html;
        try_files $uri $uri/ /index.php?$args;

        location ~ \.php$ {
            fastcgi_pass wordpress:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    location ~ ^/wp-login\.php$ {
        root /var/www/html;
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ ^/wp-includes/ {
        root /var/www/html;
    }

    # WordPress uploads
    location /wp-content/uploads/ {
        root /var/www/html;
    }

    # WordPress plugins/themes assets
    location /wp-content/ {
        root /var/www/html;
    }

    # Denegar acceso a archivos sensibles
    location ~ /\.ht {
        deny all;
    }

    location = /wp-config.php {
        deny all;
    }
}
