# Rate limiting zones
limit_req_zone $binary_remote_addr zone=wp_login:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=wp_admin:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# Redirect HTTP -> HTTPS
server {
    listen 80;
    server_name commodoremalacca.club;

    # Certbot challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS
server {
    listen 443 ssl;
    http2 on;
    server_name commodoremalacca.club;

    ssl_certificate /etc/letsencrypt/live/commodoremalacca.club/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/commodoremalacca.club/privkey.pem;

    # SSL config recomendada
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

    # Headers de seguridad
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    client_max_body_size 64M;

    # ============================================
    # BLOQUEOS DE SEGURIDAD
    # ============================================

    # Bloquear xmlrpc.php - vector de ataque muy comun
    location = /xmlrpc.php {
        deny all;
        return 403;
    }

    # Bloquear acceso a archivos sensibles de WordPress
    location ~* /(?:wp-config\.php|readme\.html|license\.txt|wp-config-sample\.php)$ {
        deny all;
        return 403;
    }

    # Bloquear acceso a archivos ocultos
    location ~ /\. {
        deny all;
        return 403;
    }

    # Bloquear ejecucion PHP en uploads
    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
        return 403;
    }

    # Bloquear acceso directo a archivos PHP en plugins/themes (excepto index.php)
    location ~* /wp-content/(?:plugins|themes)/.*\.php$ {
        deny all;
        return 403;
    }

    # ============================================
    # FRONTEND NEXT.JS
    # ============================================

    location / {
        proxy_pass http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # ============================================
    # WORDPRESS API (para Next.js)
    # ============================================

    location /wp-json/ {
        # Rate limiting para API
        limit_req zone=api burst=50 nodelay;

        # Pasar a WordPress
        root /var/www/html;

        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/html/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param DOCUMENT_URI $document_uri;
        fastcgi_param DOCUMENT_ROOT /var/www/html;
        fastcgi_param SERVER_PROTOCOL $server_protocol;
        fastcgi_param GATEWAY_INTERFACE CGI/1.1;
        fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;
        fastcgi_param REMOTE_ADDR $remote_addr;
        fastcgi_param REMOTE_PORT $remote_port;
        fastcgi_param SERVER_ADDR $server_addr;
        fastcgi_param SERVER_PORT $server_port;
        fastcgi_param SERVER_NAME $server_name;
        fastcgi_param HTTPS $https if_not_empty;

        # Headers CORS para API
        add_header Access-Control-Allow-Origin "https://commodoremalacca.club" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    }

    # ============================================
    # WORDPRESS ADMIN (protegido)
    # ============================================

    location /wp-admin/ {
        # Rate limiting para admin
        limit_req zone=wp_admin burst=20 nodelay;

        root /var/www/html;
        index index.php;
        try_files $uri $uri/ /wp-admin/index.php?$args;

        location ~ \.php$ {
            fastcgi_pass wordpress:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    # Login con rate limiting estricto
    location = /wp-login.php {
        # Rate limiting muy estricto - 1 request por segundo, burst de 5
        limit_req zone=wp_login burst=5 nodelay;
        limit_req_status 429;

        root /var/www/html;
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # ============================================
    # WORDPRESS ASSETS (solo lectura)
    # ============================================

    location ~ ^/wp-includes/ {
        root /var/www/html;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /wp-content/uploads/ {
        root /var/www/html;
        expires 30d;
        add_header Cache-Control "public";

        # No ejecutar PHP en uploads
        location ~ \.php$ {
            deny all;
        }
    }

    # Solo servir assets estaticos de wp-content (CSS, JS, imagenes)
    location ~* ^/wp-content/.*\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /var/www/html;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # ============================================
    # WORDPRESS CRON (solo interno)
    # ============================================

    location = /wp-cron.php {
        # Denegar acceso externo al cron
        allow 127.0.0.1;
        allow 172.16.0.0/12;
        deny all;

        root /var/www/html;
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # ============================================
    # BLOQUEOS FINALES
    # ============================================

    # Bloquear acceso a cualquier otro PHP que no este explicitamente permitido
    location ~ \.php$ {
        deny all;
        return 403;
    }
}
